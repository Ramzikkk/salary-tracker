<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞—Ä–ø–ª–∞—Ç—ã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div id="app" class="max-w-6xl mx-auto"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, getDocs, query, where, orderBy, updateDoc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBxCYvHpwC37-NuQ_-iNhNpiApS7_qfQps",
            authDomain: "salary-tracker-b3e7f.firebaseapp.com",
            projectId: "salary-tracker-b3e7f",
            storageBucket: "salary-tracker-b3e7f.firebasestorage.app",
            messagingSenderId: "309704635672",
            appId: "1:309704635672:web:510375311149bac6701a6d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const defaultLocations = {
            box_park: { name: '–ë–æ–∫—Å –ü–∞—Ä–∫', fullHours: 15, fullSalary: 10000 },
            aport: { name: '–ê–ø–æ—Ä—Ç', fullHours: 14, fullSalary: 10000 },
            sary_arka: { name: '–°–∞—Ä—ã –ê—Ä–∫–∞', fullHours: 18, fullSalary: 13000 }
        };

        const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                           '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

        let currentUser = null;
        let shifts = [];
        let deductions = [];
        let userSettings = {
            locations: {...defaultLocations},
            cashPercent: 3
        };
        let selectedMonth = 'all';
        let showSettings = false;

        function calculateHours(startTime, endTime) {
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            let hours = endHour - startHour;
            let minutes = endMin - startMin;
            
            if (hours < 0 || (hours === 0 && minutes < 0)) {
                hours += 24;
            }
            
            return hours + (minutes / 60);
        }

        function calculateHourlySalary(location, hours) {
            const loc = userSettings.locations[location];
            const hourlyRate = loc.fullSalary / loc.fullHours;
            return hourlyRate * hours;
        }

        function calculateCashBonus(cash) {
            return cash * (userSettings.cashPercent / 100);
        }

        function getMonthKey(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }

        function getMonthName(monthKey) {
            if (monthKey === 'all') return '–í—Å–µ –≤—Ä–µ–º—è';
            const [year, month] = monthKey.split('-');
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        function getAvailableMonths() {
            const months = new Set();
            shifts.forEach(shift => {
                months.add(getMonthKey(shift.date));
            });
            return Array.from(months).sort().reverse();
        }

        function filterShiftsByMonth(month) {
            if (month === 'all') return shifts;
            return shifts.filter(shift => getMonthKey(shift.date) === month);
        }

        function filterDeductionsByMonth(month) {
            if (month === 'all') return deductions;
            return deductions.filter(d => d.month === month);
        }

        async function loadUserSettings() {
            if (!currentUser) return;
            
            try {
                const settingsDoc = await getDoc(doc(db, 'userSettings', currentUser.uid));
                if (settingsDoc.exists()) {
                    userSettings = settingsDoc.data();
                } else {
                    userSettings = {
                        locations: {...defaultLocations},
                        cashPercent: 3
                    };
                    await setDoc(doc(db, 'userSettings', currentUser.uid), userSettings);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }

        async function saveUserSettings() {
            if (!currentUser) return;
            
            try {
                await setDoc(doc(db, 'userSettings', currentUser.uid), userSettings);
                alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                showSettings = false;
                render();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
            }
        }

        async function loadData() {
            if (!currentUser) return;
            
            try {
                const shiftsSnapshot = await getDocs(
                    query(collection(db, 'shifts'), 
                          where('userId', '==', currentUser.uid),
                          orderBy('date', 'desc'))
                );
                shifts = shiftsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const deductionsSnapshot = await getDocs(
                    query(collection(db, 'deductions'), 
                          where('userId', '==', currentUser.uid))
                );
                deductions = deductionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                render();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            }
        }

        async function register() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            if (!email || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            if (password.length < 6) {
                alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                if (error.code === 'auth/email-already-in-use') {
                    alert('–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                } else if (error.code === 'auth/invalid-email') {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email');
                } else {
                    alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
                }
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                if (error.code === 'auth/invalid-credential') {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                } else {
                    alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                }
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                currentUser = null;
                shifts = [];
                deductions = [];
                selectedMonth = 'all';
                render();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            }
        }

        async function addShift() {
            const date = document.getElementById('shift-date').value;
            const location = document.getElementById('shift-location').value;
            const startTime = document.getElementById('shift-start').value;
            const endTime = document.getElementById('shift-end').value;
            const cash = parseFloat(document.getElementById('shift-cash').value);

            if (!startTime || !endTime || !cash) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const hours = calculateHours(startTime, endTime);

            if (hours <= 0) {
                alert('–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞');
                return;
            }

            const shift = {
                userId: currentUser.uid,
                date,
                location,
                startTime,
                endTime,
                hours,
                cash,
                hourlySalary: calculateHourlySalary(location, hours),
                cashBonus: calculateCashBonus(cash),
                timestamp: Date.now()
            };

            try {
                const docRef = await addDoc(collection(db, 'shifts'), shift);
                shifts.unshift({ id: docRef.id, ...shift });
                document.getElementById('shift-start').value = '';
                document.getElementById('shift-end').value = '';
                document.getElementById('shift-cash').value = '';
                render();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω—ã');
            }
        }

        async function deleteShift(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–º–µ–Ω—É?')) return;
            
            try {
                await deleteDoc(doc(db, 'shifts', id));
                shifts = shifts.filter(s => s.id !== id);
                render();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–º–µ–Ω—ã');
            }
        }

        async function addDeduction() {
            const name = document.getElementById('deduction-name').value;
            const amount = parseFloat(document.getElementById('deduction-amount').value);
            const month = selectedMonth === 'all' ? getMonthKey(new Date().toISOString().split('T')[0]) : selectedMonth;

            if (!name || !amount) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—É');
                return;
            }

            const deduction = { 
                userId: currentUser.uid,
                name, 
                amount, 
                month, 
                timestamp: Date.now() 
            };

            try {
                const docRef = await addDoc(collection(db, 'deductions'), deduction);
                deductions.push({ id: docRef.id, ...deduction });
                document.getElementById('deduction-name').value = '';
                document.getElementById('deduction-amount').value = '';
                render();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã—á–µ—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã—á–µ—Ç–∞');
            }
        }

        async function deleteDeduction(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤—ã—á–µ—Ç?')) return;

            try {
                await deleteDoc(doc(db, 'deductions', id));
                deductions = deductions.filter(d => d.id !== id);
                render();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—ã—á–µ—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—ã—á–µ—Ç–∞');
            }
        }

        function changeMonth(month) {
            selectedMonth = month;
            render();
        }

        function toggleSettings() {
            showSettings = !showSettings;
            render();
        }

        function updateLocationSetting(key, field, value) {
            userSettings.locations[key][field] = field === 'name' ? value : parseFloat(value);
        }

        function updateCashPercent(value) {
            userSettings.cashPercent = parseFloat(value);
        }

        function getStatsByLocation(monthShifts) {
            const stats = {};
            
            Object.keys(userSettings.locations).forEach(key => {
                stats[key] = {
                    name: userSettings.locations[key].name,
                    shifts: 0,
                    hours: 0,
                    cash: 0,
                    hourlySalary: 0,
                    cashBonus: 0,
                    total: 0
                };
            });

            monthShifts.forEach(shift => {
                if (stats[shift.location]) {
                    stats[shift.location].shifts++;
                    stats[shift.location].hours += shift.hours;
                    stats[shift.location].cash += shift.cash;
                    stats[shift.location].hourlySalary += shift.hourlySalary;
                    stats[shift.location].cashBonus += shift.cashBonus;
                    stats[shift.location].total += shift.hourlySalary + shift.cashBonus;
                }
            });

            return stats;
        }

        function getTotals(monthShifts, monthDeductions) {
            const totalShifts = monthShifts.length;
            const totalHours = monthShifts.reduce((sum, s) => sum + s.hours, 0);
            const totalCash = monthShifts.reduce((sum, s) => sum + s.cash, 0);
            const totalHourlySalary = monthShifts.reduce((sum, s) => sum + s.hourlySalary, 0);
            const totalCashBonus = monthShifts.reduce((sum, s) => sum + s.cashBonus, 0);
            const totalDeductions = monthDeductions.reduce((sum, d) => sum + d.amount, 0);
            const grossTotal = totalHourlySalary + totalCashBonus;
            const netTotal = grossTotal - totalDeductions;

            return {
                totalShifts,
                totalHours,
                totalCash,
                totalHourlySalary,
                totalCashBonus,
                totalDeductions,
                grossTotal,
                netTotal
            };
        }

        function renderAuth() {
            document.getElementById('app').innerHTML = `
                <div class="max-w-md mx-auto">
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">
                            üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞—Ä–ø–ª–∞—Ç—ã
                        </h1>
                        <p class="text-gray-600 text-center mb-8">–í–∞—à –ª–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä –¥–æ—Ö–æ–¥–æ–≤</p>

                        <div class="space-y-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-4">üîê –í—Ö–æ–¥</h2>
                                <div class="space-y-3">
                                    <input type="email" id="login-email" placeholder="Email" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <button onclick="window.login()" 
                                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition">
                                        –í–æ–π—Ç–∏
                                    </button>
                                </div>
                            </div>

                            <div class="border-t pt-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">‚ú® –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                                <div class="space-y-3">
                                    <input type="email" id="reg-email" placeholder="Email" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <button onclick="window.register()" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition">
                                        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <strong>üí° –°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π email (–¥–∞–∂–µ –≤—ã–¥—É–º–∞–Ω–Ω—ã–π) –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. 
                                –ì–ª–∞–≤–Ω–æ–µ - –∑–∞–ø–æ–º–Ω–∏—Ç–µ –µ–≥–æ –∏ –ø–∞—Ä–æ–ª—å!
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSettings() {
            document.getElementById('app').innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                        <button onclick="window.toggleSettings()" 
                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-gray-50 p-6 rounded-xl">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">üíµ –ü—Ä–æ—Ü–µ–Ω—Ç —Å –∫–∞—Å—Å—ã</h2>
                            <div class="flex items-center gap-4">
                                <input type="number" step="0.1" value="${userSettings.cashPercent}" 
                                    onchange="window.updateCashPercent(this.value)"
                                    class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <span class="text-gray-700 font-semibold">%</span>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-6 rounded-xl">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">üìç –¢–æ—á–∫–∏ —Ä–∞–±–æ—Ç—ã</h2>
                            <div class="space-y-4">
                                ${Object.entries(userSettings.locations).map(([key, loc]) => `
                                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                                <input type="text" value="${loc.name}" 
                                                    onchange="window.updateLocationSetting('${key}', 'name', this.value)"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–ª–Ω–∞—è —Å–º–µ–Ω–∞ (—á–∞—Å—ã)</label>
                                                <input type="number" step="0.5" value="${loc.fullHours}" 
                                                    onchange="window.updateLocationSetting('${key}', 'fullHours', this.value)"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–û–∫–ª–∞–¥ (‚Ç∏)</label>
                                                <input type="number" value="${loc.fullSalary}" 
                                                    onchange="window.updateLocationSetting('${key}', 'fullSalary', this.value)"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="window.saveUserSettings()" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition text-lg">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            </button>
                            <button onclick="window.toggleSettings()" 
                                class="px-6 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-4 rounded-lg transition">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∞—Ä—ã–µ —Å–º–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è —Å —Ç–µ–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, 
                                —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –æ–Ω–∏ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∫ –Ω–æ–≤—ã–º —Å–º–µ–Ω–∞–º.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMain() {
            const availableMonths = getAvailableMonths();
            const monthShifts = filterShiftsByMonth(selectedMonth);
            const monthDeductions = filterDeductionsByMonth(selectedMonth);
            const stats = getStatsByLocation(monthShifts);
            const totals = getTotals(monthShifts, monthDeductions);
            const today = new Date().toISOString().split('T')[0];

            document.getElementById('app').innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞—Ä–ø–ª–∞—Ç—ã</h1>
                            <p class="text-gray-600">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${currentUser.email}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.toggleSettings()" 
                                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition">
                                ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                            </button>
                            <button onclick="window.logout()" 
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition">
                                üö™ –í—ã—Ö–æ–¥
                            </button>
                        </div>
                    </div>
                </div>

                ${availableMonths.length > 0 ? `
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</h2>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="window.changeMonth('all')" 
                            class="px-4 py-2 rounded-lg font-semibold transition ${selectedMonth === 'all' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                            –í—Å–µ –≤—Ä–µ–º—è
                        </button>
                        ${availableMonths.map(month => `
                            <button onclick="window.changeMonth('${month}')" 
                                class="px-4 py-2 rounded-lg font-semibold transition ${selectedMonth === month ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                ${getMonthName(month)}
                            </button>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-6 text-white mb-6">
                    <h2 class="text-2xl font-bold mb-4">üìä ${getMonthName(selectedMonth)}</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white bg-opacity-20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-1">–°–º–µ–Ω</div>
                            <div class="text-3xl font-bold">${totals.totalShifts}</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-1">–ß–∞—Å–æ–≤</div>
                            <div class="text-3xl font-bold">${totals.totalHours.toFixed(1)}—á</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-1">–ö–∞—Å—Å–∞</div>
                            <div class="text-2xl font-bold">${totals.totalCash.toLocaleString()}‚Ç∏</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-1">–ó–ü —Å –æ–∫–ª–∞–¥–∞</div>
                            <div class="text-2xl font-bold">${totals.totalHourlySalary.toFixed(0).toLocaleString()}‚Ç∏</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-1">–ó–ü —Å –∫–∞—Å—Å—ã (${userSettings.cashPercent}%)</div>
                            <div class="text-2xl font-bold">${totals.totalCashBonus.toFixed(0).toLocaleString()}‚Ç∏</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-1">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                            <div class="text-2xl font-bold">${totals.grossTotal.toFixed(0).toLocaleString()}‚Ç∏</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-1">–í—ã—á–µ—Ç—ã</div>
                            <div class="text-2xl font-bold text-red-300">-${totals.totalDeductions.toLocaleString()}‚Ç∏</div>
                        </div>
                        <div class="bg-white bg-opacity-30 rounded-lg p-4 border-2 border-white">
                            <div class="text-sm opacity-90 mb-1">–ö –ü–û–õ–£–ß–ï–ù–ò–Æ</div>
                            <div class="text-3xl font-bold">${totals.netTotal.toFixed(0).toLocaleString()}‚Ç∏</div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–º–µ–Ω—É</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ –î–∞—Ç–∞</label>
                                <input type="date" id="shift-date" value="${today}" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üìç –¢–æ—á–∫–∞</label>
                                <select id="shift-location" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    ${Object.entries(userSettings.locations).map(([key, loc]) => 
                                        `<option value="${key}">${loc.name} (${loc.fullHours}—á - ${loc.fullSalary}‚Ç∏)</option>`
                                    ).join('')}
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üïê –ù–∞—á–∞–ª–æ</label>
                                    <input type="time" id="shift-start" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üïê –ö–æ–Ω–µ—Ü</label>
                                    <input type="time" id="shift-end" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üíµ –ö–∞—Å—Å–∞ (‚Ç∏)</label>
                                <input type="number" id="shift-cash" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 50000" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>

                            <button onclick="window.addShift()" 
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–º–µ–Ω—É
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">üí∏ –í—ã—á–µ—Ç—ã ${selectedMonth !== 'all' ? '(' + getMonthName(selectedMonth) + ')' : ''}</h2>
                        
                        <div class="space-y-4 mb-4">
                            <input type="text" id="deduction-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–∞–≤–∞–Ω—Å, —à—Ç—Ä–∞—Ñ)" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <input type="number" id="deduction-amount" placeholder="–°—É–º–º–∞ (‚Ç∏)" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <button onclick="window.addDeduction()" 
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition">
                                –î–æ–±–∞–≤–∏—Ç—å –≤—ã—á–µ—Ç
                            </button>
                        </div>

                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${monthDeductions.map(d => `
                                <div class="flex justify-between items-center bg-red-50 p-3 rounded-lg">
                                    <div>
                                        <div class="font-semibold text-gray-800">${d.name}</div>
                                        <div class="text-red-600">-${d.amount.toLocaleString()}‚Ç∏</div>
                                    </div>
                                    <button onclick="window.deleteDeduction('${d.id}')" 
                                        class="text-red-600 hover:text-red-800 text-xl">üóëÔ∏è</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    ${Object.entries(stats).map(([key, stat]) => `
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">${stat.name}</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–°–º–µ–Ω:</span>
                                    <span class="font-semibold">${stat.shifts}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–ß–∞—Å–æ–≤:</span>
                                    <span class="font-semibold">${stat.hours.toFixed(1)}—á</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–ö–∞—Å—Å–∞:</span>
                                    <span class="font-semibold">${stat.cash.toLocaleString()}‚Ç∏</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–ó–ü (–æ–∫–ª–∞–¥):</span>
                                    <span class="font-semibold text-green-600">${stat.hourlySalary.toFixed(0).toLocaleString()}‚Ç∏</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–ó–ü (–∫–∞—Å—Å–∞):</span>
                                    <span class="font-semibold text-green-600">${stat.cashBonus.toFixed(0).toLocaleString()}‚Ç∏</span>
                                </div>
                                <div class="flex justify-between pt-2 border-t">
                                    <span class="text-gray-800 font-bold">–í—Å–µ–≥–æ:</span>
                                    <span class="font-bold text-indigo-600">${stat.total.toFixed(0).toLocaleString()}‚Ç∏</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìã –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–î–∞—Ç–∞</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–¢–æ—á–∫–∞</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">–í—Ä–µ–º—è</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">–ß–∞—Å—ã</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">–ö–∞—Å—Å–∞</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">–ó–ü (–æ–∫–ª–∞–¥)</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">–ó–ü (–∫–∞—Å—Å–∞)</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">–ò—Ç–æ–≥–æ</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${monthShifts.map(shift => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 text-sm text-gray-700">${shift.date}</td>
                                        <td class="px-4 py-3 text-sm text-gray-700">${userSettings.locations[shift.location]?.name || shift.location}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-700">${shift.startTime}-${shift.endTime}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-700">${shift.hours.toFixed(1)}—á</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-700">${shift.cash.toLocaleString()}‚Ç∏</td>
                                        <td class="px-4 py-3 text-sm text-right text-green-600 font-semibold">
                                            ${shift.hourlySalary.toFixed(0).toLocaleString()}‚Ç∏
                                        </td>
                                        <td class="px-4 py-3 text-sm text-right text-green-600 font-semibold">
                                            ${shift.cashBonus.toFixed(0).toLocaleString()}‚Ç∏
                                        </td>
                                        <td class="px-4 py-3 text-sm text-right text-indigo-600 font-bold">
                                            ${(shift.hourlySalary + shift.cashBonus).toFixed(0).toLocaleString()}‚Ç∏
                                        </td>
                                        <td class="px-4 py-3">
                                            <button onclick="window.deleteShift('${shift.id}')" 
                                                class="text-red-600 hover:text-red-800 text-xl">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function render() {
            if (!currentUser) {
                renderAuth();
            } else if (showSettings) {
                renderSettings();
            } else {
                renderMain();
            }
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                await loadUserSettings();
                await loadData();
            } else {
                render();
            }
        });

        window.register = register;
        window.login = login;
        window.logout = logout;
        window.addShift = addShift;
        window.deleteShift = deleteShift;
        window.addDeduction = addDeduction;
        window.deleteDeduction = deleteDeduction;
        window.changeMonth = changeMonth;
        window.toggleSettings = toggleSettings;
        window.updateLocationSetting = updateLocationSetting;
        window.updateCashPercent = updateCashPercent;
        window.saveUserSettings = saveUserSettings;

        render();
    </script>
</body>
</html>
