<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞—Ä–ø–ª–∞—Ç—ã</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, setDoc, getDoc, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const MANAGER_EMAIL = "gcsalary@gmail.com";

        const firebaseConfig = {
            apiKey: "AIzaSyBxCYvHpwC37-NuQ_-iNhNpiApS7_qfQps",
            authDomain: "salary-tracker-b3e7f.firebaseapp.com",
            projectId: "salary-tracker-b3e7f",
            storageBucket: "salary-tracker-b3e7f.firebasestorage.app",
            messagingSenderId: "309704635672",
            appId: "1:309704635672:web:510375311149bac6701a6d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userProfile = null;
        let shifts = [];
        let deductions = [];
        let allBaristas = [];
        let selectedMonth = 'all';
        let selectedBaristaId = 'all';
        let showSettings = false;
        let userSettings = {
            cashPercent: 3,
            locations: {
                boxpark: { name: '–ë–æ–∫—Å –ø–∞—Ä–∫', fullHours: 15, fullSalary: 10000 },
                aport: { name: '–ê–ø–æ—Ä—Ç', fullHours: 14, fullSalary: 10000 },
                saryarka: { name: '–°–∞—Ä—ã –∞—Ä–∫–∞', fullHours: 18, fullSalary: 13000 }
            }
        };

        async function register() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value;
            const role = document.getElementById('auth-role').value;
        
            if (!email || !password || !name) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
        
            try {
                const actualRole = email.toLowerCase() === MANAGER_EMAIL.toLowerCase() ? 'manager' : role;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
        
                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    role: actualRole,
                    createdAt: new Date().toISOString()
                });
        
                await setDoc(doc(db, 'userSettings', user.uid), userSettings);
                alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function login() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                currentUser = null;
                userProfile = null;
                shifts = [];
                deductions = [];
                selectedMonth = 'all';
                showSettings = false;
                render();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
            }
        }

        async function loadUserProfile() {
            if (!currentUser) {
                console.error('loadUserProfile: currentUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                return;
            }
            
            console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è UID:', currentUser.uid);
            
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                
                if (userDoc.exists()) {
                    userProfile = { id: currentUser.uid, ...userDoc.data() };
                    console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', userProfile);
                } else {
                    console.error('‚ùå –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Firestore!');
                    console.log('üîß –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞...');
                    
                    const newProfile = {
                        name: currentUser.email.split('@')[0],
                        email: currentUser.email,
                        role: currentUser.email.toLowerCase() === MANAGER_EMAIL.toLowerCase() ? 'manager' : 'barista',
                        createdAt: new Date().toISOString()
                    };
                    
                    await setDoc(doc(db, 'users', currentUser.uid), newProfile);
                    userProfile = { id: currentUser.uid, ...newProfile };
                    console.log('‚úÖ –ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω:', userProfile);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤ loadUserProfile:', error);
                throw error;
            }
        }

        async function loadUserSettings() {
            if (!currentUser) return;
            
            try {
                const settingsDoc = await getDoc(doc(db, 'userSettings', currentUser.uid));
                
                if (settingsDoc.exists()) {
                    userSettings = settingsDoc.data();
                } else {
                    console.log('üîß –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞...');
                    await setDoc(doc(db, 'userSettings', currentUser.uid), userSettings);
                    console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã!');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }

        async function loadData() {
            if (!currentUser || !userProfile) {
                console.error('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                return;
            }

            try {
                if (userProfile.role === 'manager') {
                    await loadAllBaristas();
                    await loadAllShifts();
                    await loadAllDeductions();
                } else {
                    await loadMyShifts();
                    await loadMyDeductions();
                }

                render();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }

        async function loadAllBaristas() {
            const q = query(collection(db, 'users'), where('role', 'in', ['barista', 'intern']));
            const snapshot = await getDocs(q);
            allBaristas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadAllShifts() {
            const q = query(collection(db, 'shifts'), orderBy('date', 'desc'));
            const snapshot = await getDocs(q);
            shifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadAllDeductions() {
            const snapshot = await getDocs(collection(db, 'deductions'));
            deductions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadMyShifts() {
            const q = query(
                collection(db, 'shifts'),
                where('userId', '==', currentUser.uid),
                orderBy('date', 'desc')
            );
            const snapshot = await getDocs(q);
            shifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadMyDeductions() {
            const q = query(collection(db, 'deductions'), where('userId', '==', currentUser.uid));
            const snapshot = await getDocs(q);
            deductions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function renderAuth() {
            document.getElementById('app').innerHTML = `
                <div class="max-w-md mx-auto">
                    <div class="bg-white rounded-2xl shadow-2xl p-8">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-2">üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
                            <p class="text-gray-600">–ó–∞—Ä–ø–ª–∞—Ç—ã –±–∞—Ä–∏—Å—Ç</p>
                        </div>

                        <div class="space-y-4 mb-6">
                            <input type="email" id="auth-email" placeholder="Email" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <input type="text" id="auth-name" placeholder="–í–∞—à–µ –∏–º—è" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <select id="auth-role" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="barista">‚òï –ë–∞—Ä–∏—Å—Ç–∞</option>
                                <option value="intern">üë®‚Äçüéì –°—Ç–∞–∂—ë—Ä</option>
                            </select>
                        </div>

                        <div class="bg-green-50 border border-green-200 p-3 rounded-lg mb-4">
                            <p class="text-xs text-green-800">
                                üîê <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> –†–æ–ª—å –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                            </p>
                        </div>

                        <div class="space-y-3">
                            <button onclick="window.login()" 
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">
                                üîë –í–æ–π—Ç–∏
                            </button>
                            <button onclick="window.register()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">
                                ‚ûï –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            if (!currentUser || !userProfile) {
                renderAuth();
            } else {
                document.getElementById('app').innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h1 class="text-3xl font-bold text-gray-800 mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userProfile.name}!</h1>
                        <p class="text-gray-600 mb-4">–†–æ–ª—å: ${userProfile.role}</p>
                        <button onclick="window.logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                            –í—ã—Ö–æ–¥
                        </button>
                    </div>
                `;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                try {
                    await loadUserProfile();
                    
                    if (!userProfile) {
                        console.error('–û—à–∏–±–∫–∞: –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.');
                        await logout();
                        return;
                    }
                    
                    await loadUserSettings();
                    await loadData();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                }
            } else {
                render();
            }
        });

        window.register = register;
        window.login = login;
        window.logout = logout;

        render();
    </script>
</body>
</html>